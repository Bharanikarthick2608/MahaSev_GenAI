<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Demand Forecasting Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #111827;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #bfdbfe;
            font-size: 0.95rem;
        }

        .nav-tabs {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 2rem;
            padding: 0 2rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .nav-tab {
            padding: 1rem 0.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            color: #6b7280;
        }

        .nav-tab:hover {
            color: #2563eb;
        }

        .nav-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .kpi-icon.blue { background: #dbeafe; color: #2563eb; }
        .kpi-icon.green { background: #e3f2fd; color: #1976d2; }
        .kpi-icon.red { background: #fee2e2; color: #dc2626; }
        .kpi-icon.yellow { background: #fef3c7; color: #d97706; }
        .kpi-icon.purple { background: #ede9fe; color: #7c3aed; }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .kpi-trend.up { color: #1976d2; }
        .kpi-trend.down { color: #dc2626; }

        .kpi-body p {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 1.875rem;
            font-weight: bold;
            color: #111827;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .chart-container h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #111827;
        }

        .filter-panel {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-group select,
        .form-group input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-box.green { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); }
        .stat-box.purple { background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); }

        .stat-box p {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2563eb;
        }

        .stat-box.green .value { color: #1976d2; }
        .stat-box.purple .value { color: #7c3aed; }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 1.5rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Service Demand Forecasting System</h1>
        <p>AI-Powered Demand Prediction using TimeGEN</p>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('overview')">Overview</div>
        <div class="nav-tab" onclick="switchTab('forecast')">Forecast</div>
        <div class="nav-tab" onclick="switchTab('analytics')">Analytics</div>
    </div>

    <div class="container">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <h2 class="section-title">Performance Overview</h2>
            
            <div class="kpi-grid" id="kpiGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading KPIs...</p>
                </div>
            </div>

            <div class="chart-container">
                <h3>Historical Request Trend (Last 90 Days)</h3>
                <canvas id="historicalChart"></canvas>
            </div>
        </div>

        <!-- Forecast Tab -->
        <div id="forecast" class="tab-content">
            <h2 class="section-title">Demand Forecasting</h2>
            
            <div class="filter-panel">
                <h3>Configure Forecast</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label>Service Category</label>
                        <select id="serviceCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sub Category</label>
                        <select id="subCategory">
                            <option value="">All Sub-Categories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>District</label>
                        <select id="district">
                            <option value="">All Districts</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Area</label>
                        <select id="area">
                            <option value="">All Areas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="priority">
                            <option value="">All Priorities</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Forecast Horizon (Days)</label>
                        <input type="number" id="forecastHorizon" value="30" min="7" max="90">
                    </div>
                </div>
                <button class="btn-primary" onclick="generateForecast()" id="forecastBtn">
                    Generate Forecast
                </button>
            </div>

            <div id="forecastResults" style="display: none;">
                <div class="chart-container">
                    <h3>Predicted Service Demand</h3>
                    <canvas id="forecastChart"></canvas>
                </div>

                <div class="stats-grid" id="forecastStats"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h2 class="section-title">Service Analytics</h2>
            
            <div class="analytics-grid">
                <div class="chart-container">
                    <h3>Service Category Distribution</h3>
                    <canvas id="categoryPieChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Top Service Categories</h3>
                    <canvas id="categoryBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let historicalChart = null;
        let forecastChart = null;
        let categoryPieChart = null;
        let categoryBarChart = null;

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Load filter options
        async function loadFilters() {
            try {
                const response = await fetch(`${API_BASE_URL}/filters`);
                const data = await response.json();

                // Populate dropdowns
                populateSelect('serviceCategory', data.service_categories);
                populateSelect('subCategory', data.sub_categories);
                populateSelect('district', data.districts);
                populateSelect('area', data.areas);
                populateSelect('priority', data.priorities);
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            const currentValue = select.value;
            
            // Clear existing options except first one
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add new options
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            select.value = currentValue;
        }

        // Load KPIs
        async function loadKPIs() {
            try {
                const response = await fetch(`${API_BASE_URL}/kpis`);
                const kpis = await response.json();

                const kpiGrid = document.getElementById('kpiGrid');
                kpiGrid.innerHTML = `
                    ${createKPICard('Total Requests', kpis.total_requests.toLocaleString(), 'üìä', 'blue')}
                    ${createKPICard('Avg Daily Requests', kpis.avg_daily_requests, 'üìÖ', 'green', kpis.mom_growth_pct)}
                    ${createKPICard('Resolution Rate', kpis.resolution_rate + '%', '‚úì', 'green')}
                    ${createKPICard('Critical Priority', kpis.critical_priority_pct + '%', '‚ö†', 'red')}
                    ${createKPICard('Avg Resolution Time', kpis.avg_resolution_days + ' days', '‚è±', 'yellow')}
                    ${createKPICard('Escalation Rate', kpis.escalation_rate + '%', '‚Üë', 'red')}
                    ${createKPICard('Satisfaction Rate', kpis.satisfaction_rate + '%', 'üòä', 'green')}
                    ${createKPICard('Top District', kpis.top_district, 'üìç', 'purple')}
                    ${createKPICard('Most Common Service', kpis.most_common_category, 'üîß', 'blue')}
                    ${createKPICard('Peak Request Day', kpis.peak_request_day, 'üìÜ', 'purple')}
                `;
            } catch (error) {
                console.error('Error loading KPIs:', error);
            }
        }

        function createKPICard(title, value, icon, color, trend) {
            const trendHTML = trend ? `
                <div class="kpi-trend ${trend > 0 ? 'up' : 'down'}">
                    ${trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(trend)}%
                </div>
            ` : '';

            return `
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon ${color}">${icon}</div>
                        ${trendHTML}
                    </div>
                    <div class="kpi-body">
                        <p>${title}</p>
                        <div class="kpi-value">${value}</div>
                    </div>
                </div>
            `;
        }

        // Load historical data
        async function loadHistoricalData() {
            try {
                const response = await fetch(`${API_BASE_URL}/historical-data?limit=90`);
                const data = await response.json();

                const ctx = document.getElementById('historicalChart').getContext('2d');
                
                if (historicalChart) {
                    historicalChart.destroy();
                }

                historicalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates.reverse(),
                        datasets: [{
                            label: 'Requests',
                            data: data.request_counts.reverse(),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }

        // Load category distribution
        async function loadCategoryDistribution() {
            try {
                const response = await fetch(`${API_BASE_URL}/category-distribution`);
                const data = await response.json();

                // Pie Chart
                const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
                if (categoryPieChart) {
                    categoryPieChart.destroy();
                }

                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

                categoryPieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: data.categories,
                        datasets: [{
                            data: data.counts,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Bar Chart (top 5)
                const barCtx = document.getElementById('categoryBarChart').getContext('2d');
                if (categoryBarChart) {
                    categoryBarChart.destroy();
                }

                categoryBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: data.categories.slice(0, 5),
                        datasets: [{
                            label: 'Request Count',
                            data: data.counts.slice(0, 5),
                            backgroundColor: '#3B82F6'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading category distribution:', error);
            }
        }

        // Generate forecast
        async function generateForecast() {
            const btn = document.getElementById('forecastBtn');
            btn.disabled = true;
            btn.textContent = 'Generating Forecast...';

            try {
                const requestBody = {
                    service_category: document.getElementById('serviceCategory').value || null,
                    sub_category: document.getElementById('subCategory').value || null,
                    district: document.getElementById('district').value || null,
                    area: document.getElementById('area').value || null,
                    priority: document.getElementById('priority').value || null,
                    forecast_horizon: parseInt(document.getElementById('forecastHorizon').value)
                };

                const response = await fetch(`${API_BASE_URL}/forecast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Show results
                document.getElementById('forecastResults').style.display = 'block';

                // Create forecast chart
                const ctx = document.getElementById('forecastChart').getContext('2d');
                
                if (forecastChart) {
                    forecastChart.destroy();
                }

                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.forecast_dates,
                        datasets: [
                            {
                                label: 'Upper Bound (95%)',
                                data: data.confidence_upper,
                                borderColor: '#93C5FD',
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'Predicted Requests',
                                data: data.predicted_requests,
                                borderColor: '#2563eb',
                                borderWidth: 3,
                                fill: false
                            },
                            {
                                label: 'Lower Bound (95%)',
                                data: data.confidence_lower,
                                borderColor: '#93C5FD',
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Calculate statistics
                const avgPredicted = data.predicted_requests.reduce((a, b) => a + b, 0) / data.predicted_requests.length;
                const maxPredicted = Math.max(...data.predicted_requests);
                const totalPredicted = data.predicted_requests.reduce((a, b) => a + b, 0);

                document.getElementById('forecastStats').innerHTML = `
                    <div class="stat-box">
                        <p>Average Predicted Requests</p>
                        <div class="value">${avgPredicted.toFixed(1)}</div>
                    </div>
                    <div class="stat-box green">
                        <p>Peak Predicted Day</p>
                        <div class="value">${maxPredicted.toFixed(1)}</div>
                    </div>
                    <div class="stat-box purple">
                        <p>Total Predicted Requests</p>
                        <div class="value">${totalPredicted.toFixed(0)}</div>
                    </div>
                `;

            } catch (error) {
                console.error('Error generating forecast:', error);
                alert('Error generating forecast. Please check your filters and try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Forecast';
            }
        }

        // Initialize dashboard
        async function init() {
            await loadFilters();
            await loadKPIs();
            await loadHistoricalData();
            await loadCategoryDistribution();
        }

        // Load on page ready
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>